

[[annexC]]
[appendix]
== Sampling from probability distributions

=== General


==== {blank}

This annex provides technical information concerning sampling from probability distributions. Such sampling forms a central part of the use of MCM as an implementation of the propagation of distributions. A digital library of mathematical functions <<nistdigital>> and a repository of relevant software <<Nerlib>> may also be consulted.


[[scls_C-1-2]]
==== {blank}

A generator for any distribution, such as the distributions considered in <<scls_6-4>> (also see table 1), can in principle be obtained from its distribution function, together with the use of a generator for the rectangular distribution, as indicated in <<scls_C-2>>. A generator for a rectangular distribution is provided in <<scls_C-3-3>>. For some distributions, such as the Gaussian distribution and the stem:[t]-distribution, it is more efficient to use specifically developed generators, such as those provided in this annex. Subclause <<scls_6-4>> also gives advice on sampling from probability distributions.


NOTE: Generators other than those given in this annex can be used. Their statistical quality should be tested before use. A testing facility is available for pseudo-random number generators for the rectangular distribution. See <<scls_C-3-2>>.


[[scls_C-2]]
=== General distributions

A draw from any strictly increasing, univariate continuous distribution function stem:[G_X (xi)] can be made by transforming a draw from a rectangular distribution:

. draw a random number stem:[rho] from the rectangular distribution stem:[R(0, 1)];
. [[item_c-2b]]determine stem:[xi] satisfying stem:[G_X (xi) = rho].

NOTE: The inversion required in step <<item_c-2b>>, that is forming stem:[xi = G_X^{-1} (rho)], may be possible analytically. Otherwise it can be carried out numerically.

[example]
As an instance of analytical inversion, consider the exponential PDF for stem:[ii(X)], with stem:[ii(X)] having expectation stem:[x (> 0)], viz. stem:[g_X (xi) = exp(-xi//x)//x], for stem:[xi >= 0], and zero otherwise (see <<scls_6-4-10>>). Then, by integration, stem:[G_X (xi) = 1 - exp(-xi//x)], for stem:[xi >= 0], and zero otherwise. Hence stem:[xi = -x ln(1 - rho)]. This result can be simplified slightly by using the fact that if a variable stem:[Q] has the rectangular distribution stem:[R(0, 1)], then so has stem:[1 - Q]. Hence, stem:[xi = -x ln rho].

NOTE: Numerically, stem:[xi] can generally be determined by solving the "zero-of-a-function" problem stem:[G_X (xi) - rho = 0]. Upper and lower bounds for stem:[xi] are typically easily found, in which case a recognized "bracketing" algorithm such as bisection or, more efficiently, a combination of linear interpolation and bisection <<Dekker1969>>, for example, can be used to determine stem:[xi].

NOTE: If the pseudo-random number generator for the rectangular distribution is to be used as a basis for generating numbers from another distribution, a draw of stem:[rho] equal to zero or one can cause failure of that generator. An example is the exponential distribution (see <<scls_6-4-10>>). Its PDF (<<eq9>>) is not defined for stem:[rho] equal to zero or one. The use of the generator given in <<scls_C-3-3>> would not give rise to a failure of that type.


[[scls_C-3]]
=== Rectangular distribution

==== General

===== {blank}

The ability to generate pseudo-random numbers from a rectangular distribution is fundamental in its own right, and also as the basis for generating pseudo-random numbers from any distribution (see <<scls_C-2>>, <<scls_C-4>> and <<scls_C-6>>) using an appropriate algorithm or formula. In the latter regard, the quality of the numbers generated from a non-rectangular distribution depends on that of the generator of numbers from a rectangular distribution and on the properties of the algorithm employed. The quality of the numbers generated from a non-rectangular distribution can therefore be expected to be related to those generated from the rectangular distribution. Only a generator that can faithfully provide rectangularly distributed numbers used in conjunction with a good algorithm can be expected to constitute a generator that can faithfully provide non-rectangularly distributed numbers.


===== {blank}

It is thus important that the underlying facility for generating rectangularly distributed numbers is sound <<Leydold2000>>. Unless the user is sure of its pedigree, a generator should not be used until adequate testing has been carried out. Misleading results can otherwise be obtained. The use of a testing facility <<Ecuyerm>> is recommended. A procedure for generating rectangularly distributed numbers, which has been shown to perform well in these tests and is straightforward to implement, is given in <<scls_C-3-3>>.


[[scls_C-3-1-3]]
===== {blank}

<<tablec1>> defines relevant aspects of the functioning of a procedure for generating pseudo-random numbers from the rectangular distribution stem:[R(0, 1)], specifying the input, input-output and output parameters associated with their determination.

NOTE: By setting the seeds in <<tablec1>> to seeds previously used, the same sequence of random numbers can be produced. Doing so is important as part of software regression testing, used to verify the consistency of results produced using the software with those from previous versions.

NOTE: Some pseudo-random number generators provide a single draw at each call and others several draws.


[[tablec1]]
.Generation of pseudo-random numbers from a rectangular distribution (<<scls_C-3-1-3>>, <<scls_C-3-2-2>>)
[cols="1*"]
|===
^h| Input parameter
a|
stem:[q]:: Number of pseudo-random numbers to be generated

^h| Input-output parameter
a|
stem:[bb(t)]:: Column vector of parameters, some of which may be required as input quantities, that may be changed as part of the computation. Subsequent values of these parameters are not usually of immediate concern to the user. The parameters are needed to help control the process by which the pseudo-random numbers are generated. The parameters may be realized as global variables and thus not explicitly appear as parameters of the procedure. One or more of these parameters may be a seed, used to initiate the sequence of random numbers produced by successive calls of the procedure

^h| Output parameter
a|
stem:[z]:: Column vector of stem:[q] draws from the rectangular distribution stem:[R(0, 1)]
|===


===== {blank}

A pseudo-random number stem:[x] drawn from stem:[R(a, b)] is given by stem:[a + (b - a)z], where stem:[z] is a pseudo-random number drawn from stem:[R(0, 1)].


[[scls_C-3-2]]
==== Randomness tests

===== {blank}

Any pseudo-random number generator used should

. have good statistical properties,
. readily be implemented in any programming language, and
. give the same results for the same seed on any computer.


It is also desirable that it is compact, thus rendering its implementation straightforward. One such generator that comes close to satisfying these requirements is that due to Wichmann and Hill <<Wichmann1982>>, <<Wichmann1984>>. It has been used in many areas including uncertainty computations. However, its cycle length (the number of random numbers generated before the sequence is repeated) is stem:[2^{31}], today considered inadequate for some problems. Moreover, not all tests of its statistical properties were passed <<McCullough2004>>. Further, the generator was designed for 16-bit computers, whereas today 32-bit and 64-bit computers are almost universally used.


NOTE: The period of the sequence of numbers produced by a pseudo-random number generator is the number of consecutive numbers in the sequence before they are repeated.


[[scls_C-3-2-2]]
===== {blank}

An extensive test of the statistical properties of any generator submitted to it is carried out by the test suite TestU01 <<Ecuyerm>>. This suite is very detailed, with many individual tests, including the so-called Big Crush. Several generators passing the Big Crush test are listed by Wichmann and Hill <<Wichmann1622>>. An enhanced Wichmann-Hill generator (see <<scls_C-3-3>>) also passes the test, and has the properties <<Wichmann1622>> that

. it is straightforward to code in any programming language. It does not depend upon bit manipulation used by some generators,
. the state (the amount of information preserved by the generator between calls to it) is small and easy to handle (cf. the parameter stem:[bb(t)] in <<tablec1>>,
. it can readily be used to provide multiple sequences needed for highly parallel applications, likely to be a feature of future uncertainty calculations, and
. there are variants of the generator for 32- and 64-bit computers.


[[scls_C-3-3]]
==== Procedure for generating pseudo-random numbers from a rectangular distribution

===== {blank}

Like the previous generator, the enhanced Wichmann-Hill generator is a combination of congruential generators. The new generator combines four such generators, whereas the previous version combined three. The new generator has a period of stem:[2^{121}], acceptable for any conceivable application.


[[scls_C-3-3-2]]
===== {blank}

<<tablec2>> defines the enhanced Wichmann-Hill generator for producing pseudo-random numbers from stem:[R(0, 1)] for a 32-bit computer.


[[tablec2]]
.The enhanced Wichmann-Hill generator for pseudo-random numbers (<<scls_C-3-3-2>>, <<scls_C-3-3-3>>) from a rectangular distribution on the interval (0, 1) for 32-bit computers. bwc denotes the largest integer no greater than stem:[w]. stem:[i_j mod b_j] denotes the remainder on division of stem:[i_j] by stem:[b_j]
[cols="1*"]
|===
^h| Input parameter
| None
^h| Input-output parameter
a|
stem:[i_1]:: Integer parameters required as input quantities and that are changed by the procedure. Set to integers between 1
stem:[i_2]:: and stem:[2147483647] before the first call. Do not disturb between calls. Subsequent values of these parameters are not
stem:[i_3]:: usually of concern to the user. The parameters provide the basis by which the pseudo-random numbers are generated.
stem:[i_4]:: They may be realized as global variables and thus not appear explicitly as parameters of the procedure

^h| Constant
a|
stem:[bb(a)]:: Vectors of integer constants of dimension stem:[1 xx 4], where stem:[bb(a) = (a_1,..., a_4)], etc., given by:
stem:[bb(b)]:: stem:[bb(a) = (11600, 47003, 23000, 33000)],
stem:[bb(c)]:: stem:[bb(b) = (185127, 45688, 93368, 65075)],
stem:[bb(d)]:: stem:[bb(c) = (10379, 10479, 19423, 8123)], +
stem:[bb(d) = 2147483123 xx (1, 1, 1, 1) + (456, 420, 300, 0)]. Do not disturb between calls


^h| Output parameter
a|
stem:[r]:: Pseudo-random number drawn from stem:[R(0, 1)]


^h| Computation
a|
. [[item_comp-a]]For stem:[j = 1,...,4]:
.. Form stem:[i_j = a_j xx (i_j mod b_j) - c_j xx floor(i_j//b_j)]
.. If stem:[i_j < 0], replace stem:[i_j] by stem:[i_j + d_j]
. Form stem:[w = sum_{j=1}^4 i_j//d_j]
. Form stem:[r = w - floor(w)]
|===


[[scls_C-3-3-3]]
===== {blank}

For 64-bit computers, step <<item_comp-a>> of Computation, including (i) and (ii), in the generator of <<tablec2>> is to be replaced by the simpler step:

. For stem:[j = 1,..., 4], form stem:[i_j = (a_j xx i_j) mod d_j]


[[scls_C-4]]
=== Gaussian distribution

The procedure in <<tablec3>> provides draws from the standard Gaussian distribution stem:[N(0, 1)] using the Box-Muller transform <<Box1958>>. A draw from the Gaussian distribution stem:[N(mu,sigma^2)] is given by stem:[mu + sigma z], where stem:[z] is a draw from stem:[N(0, 1)].


[[tablec3]]
.The Box-Muller Gaussian pseudo-random number generator (<<scls_C-4>>)
[cols="1*"]
|===
^h| Input parameter
| None

^h| Output parameter
a|
stem:[z_1,z_2]:: Two draws, obtained independently, from a standard Gaussian distribution stem:[z_2]

^h| Computation
a|
. Generate random draws stem:[r_1] and stem:[r_2] independently from the rectangular distribution stem:[R(0,1)]
. Form stem:[z_1 = sqrt(- 2 ln r_1) cos 2pir_2] and stem:[z_2 = sqrt(-2 ln r_1) sin 2pir_2]
|===


[[scls_C-5]]
=== Multivariate Gaussian distribution

==== {blank}

The most important multivariate distribution is the multivariate (or joint) Gaussian distribution stem:[N(mu,V)], where stem:[mu] is a vector of expectations of dimension stem:[n xx 1] and stem:[V] a covariance matrix of dimension stem:[ii(N) xx ii(N)].


[[scls_C-5-2]]
==== {blank}

Draws from stem:[N(mu, V)] <<Salter2000>>, <<Strang1997>> can be obtained using the procedure in <<tablec4>>.

NOTE: If stem:[bb(V)] is positive definite (i.e. all its eigenvalues are strictly positive), the Cholesky factor stem:[bb(R)] is unique <<Higham1996,page=204>>.

NOTE: If stem:[bb(V)] is not positive definite, perhaps because of numerical rounding errors or other sources, stem:[bb(R)] may not exist. Moreover, in cases where one or more of the eigenvalues of stem:[bb(V)] is very small (but positive), the software implementation of the Cholesky factorization algorithm used may be unable to form stem:[bb(R)] because of the effects of floating-point errors. In either of these situations it is recommended that stem:[bb(V)] is "repaired", i.e. as small a change as possible is made to V such that the Cholesky factor R for the modified matrix is well defined. The resulting factor is exact for a covariance matrix that numerically is close to the original stem:[bb(V)]. A simple repair procedure is available <<Strang1997,page=322>> for this purpose, and is embodied in the MULTNORM generator <<Salter2000>>.


NOTE: If stem:[bb(V)] is semi-positive definite, the eigendecomposition stem:[bb(V) = bb(Q wedge Q)^{sf(T)}], where stem:[Q] is an orthogonal matrix and stem:[^^] a diagonal matrix, can be formed. Then stem:[bb(^^)^{1//2} bb(Q)^{sf(T)}] can be used to obtain draws from stem:[N(0, V)], even if stem:[V] is rank deficient.


[[tablec4]]
.A multivariate Gaussian random number generator (<<scls_C-5-2>>)
[cols="1*"]
|===
^h| Input parameter
a|
stem:[n]:: Dimension of the multivariate Gaussian distribution
stem:[bb(mu)]:: Vector of expectations of dimension stem:[n xx 1]
stem:[bb(V)]:: Covariance matrix of dimension stem:[ii(N) xx ii(N)]
stem:[q]:: Number of multivariate Gaussian pseudo-random numbers to be generated

^h| Output parameter
a| 
stem:[bb(X)]:: Matrix of dimension stem:[n xx q], the __j__th column of which is a draw from the multivariate Gaussian distribution

^h| Computation
a|
. Form the Cholesky factor stem:[bb(R)] of stem:[bb(V)], i.e. the upper triangular matrix satisfying stem:[bb(V) = bb(R)^{sf(T)} bb(R)]. (To generate stem:[q] pseudo-random numbers, it is necessary to perform this matrix factorization only once.)
. Generate an array stem:[ii(Z)] of standard Gaussian variates of dimension stem:[n xx q]
. Form
+
--
[stem%unnumbered]
++++
bb(X) = bb(mu) 1^{sf(T)} + bb(R)^{sf(T)} bb(Z),
++++

where 1 denotes a vector of ones of dimension stem:[q xx 1]
--
|===


[[scls_C-5-3]]
==== {blank}

<<figc1>> shows 200 points generated using the MULTNORM generator <<Salter2000>> from stem:["N"(bb(mu),bb(V))], where

[stem%unnumbered]
++++
bb(mu) = [(2.0),(3.0)], " " " " bb(V) = [(2.0,1.9),(1.9,2.0)]
++++

i.e. in which the two quantities concerned are positively correlated. Similar generators are available elsewhere <<Devroye1986>>.


[[figc1]]
.Points sampled from a bivariate Gaussian distribution with positive correlation (<<scls_C-5-3>>, <<scls_C-5-4>>)
image::figurec1.png[]


[[scls_C-5-4]]
==== {blank}

In <<figc1>>, the points span an elongated angled ellipse. Were the off-diagonal elements of stem:[V] to be replaced by zero, the points would span a circle. Were the diagonal elements made unequal, and the off-diagonal elements kept at zero, the points would span an ellipse whose axes were parallel to the axes of the graph. If the diagonal elements were negative, and hence the quantities concerned negatively correlated, the major axis of the ellipse would have a negative rather than a positive gradient.


[[scls_C-6]]
=== stem:[t]-distribution

The procedure in <<tablec5>> provides an approach <<Kinderman1018>>, <<Robert1999,page=63>> to obtain draws from the stem:[t]-distribution with stem:[nu] degrees of freedom.


[[tablec5]]
.A stem:[t]-distribution pseudo-random number generator (<<scls_C-6>>)
[cols="1*"]
|===
^h| Input parameter
a|
stem:[nu]:: Degrees of freedom

^h| Output parameter
a|
stem:[t]:: Draw from a stem:[t]-distribution with stem:[nu] degrees of freedom

^h| Computation
a|
. [[item_C-5a]]Generate two draws stem:[r_1] and stem:[r_2] independently from the rectangular distribution stem:[R(0,1)]
. If stem:[r_1 < 1//2], form stem:[t = 1//(4r_1 - 1)] and stem:[v = r_2//t^2]; otherwise form stem:[t = 4r_1 - 3] and stem:[v = r_2]
. If stem:[v < 1 - |t|//2] or stem:[v < (1 + t^2//nu)^{-(nu+1)//2}], accept t as a draw from the stem:[t]-distribution; otherwise repeat from step <<item_C-5a>>
|===

NOTE: stem:[nu] must be greater than two for the standard deviation of the stem:[t]-distribution with stem:[nu] degrees of freedom to be finite.
